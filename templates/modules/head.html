<!-- 公共的 head 部分，可以定义部分 links,scripts,styles -->
<th:block th:fragment="head(htmlType)">
    <meta charset="UTF-8">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="width=device-width,initial-scale=1" name="viewport">
    <meta content="telephone=no" name="format-detection">
    <meta content="var(--heo-card-bg)" name="theme-color">
    <title th:text="${siteTitle}"></title>
    <link rel="shortcut icon"
          th:href="@{${#strings.isEmpty(site.favicon) ? assets_link + '/images/hao-logo.jpg' : site.favicon}}"/>

    <!-- DNS预解析和预连接优化 -->
    <link rel="dns-prefetch" th:href="${assets_link}">
    <link rel="preconnect" th:href="${assets_link}" crossorigin>
    <link rel="dns-prefetch" href="https://cloud.umami.is">
    <link rel="dns-prefetch" href="https://cn.cravatar.com">
    
    <!-- 关键CSS内联 - 最小化核心样式 -->
    <style>
        :root{--heo-card-bg:#fff;--heo-main:#425AEF;--heo-bg:#f0f2f5}
        body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;background:var(--heo-bg);-webkit-font-smoothing:antialiased}
        .container{max-width:1200px;margin:0 auto;padding:20px}
        .header{background:var(--heo-card-bg);padding:20px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
        .loading{position:fixed;top:0;left:0;width:100%;height:3px;background:linear-gradient(90deg,#425AEF,#15c6ff);z-index:9999;animation:loading 2s infinite}
        @keyframes loading{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
        /* 基础布局样式 */
        .hide-aside .aside-content{display:none}
        .color-scheme-dark{--heo-card-bg:#1e1e1e;--heo-bg:#121212}
    </style>

    <!-- 异步加载核心资源 -->
    <script>
        (function(){
            // 1. 异步加载jQuery（核心依赖）
            var jqueryScript = document.createElement('script');
            jqueryScript.src = '[[${assets_link}]]/libs/jquery/jquery.min.js';
            jqueryScript.async = true;
            document.head.appendChild(jqueryScript);

            // 2. jQuery加载完成后，异步加载heo.js
            jqueryScript.onload = function() {
                var heoScript = document.createElement('script');
                heoScript.src = '[[${assets_link}]]/js/heo.js[[${theme_version}]]';
                heoScript.async = true;
                document.head.appendChild(heoScript);
            };
        })();
    </script>

    <!-- 异步加载所有CSS - 使用media="print"技巧 -->
    <link rel="stylesheet" th:href="${assets_link}/zhheo/zhheoblog.css${theme_version}" media="print" onload="this.media='all'">
    <link rel="stylesheet" th:href="${assets_link}/zhheo/custom.css${theme_version}" media="print" onload="this.media='all'">
    <link rel="stylesheet" th:href="${assets_link}/zhheo/commentBarrage.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" th:href="${assets_link}/libs/prism/prism.min.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" th:href="${assets_link}/libs/prism/themes/prism-one-light.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" th:href="${assets_link}/libs/prism/code.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" th:href="${assets_link}/libs/node-snackbar/snackbar.min.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" th:href="${assets_link}/libs/aplayer/APlayer.min.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" th:href="${assets_link}/icon/iconfont.css${theme_version}" media="print" onload="this.media='all'">
    
    <!-- 备用noscript标签 -->
    <noscript>
        <link rel="stylesheet" th:href="${assets_link}/zhheo/zhheoblog.css${theme_version}">
        <link rel="stylesheet" th:href="${assets_link}/zhheo/custom.css${theme_version}">
        <link rel="stylesheet" th:href="${assets_link}/zhheo/commentBarrage.css">
        <link rel="stylesheet" th:href="${assets_link}/libs/prism/prism.min.css">
        <link rel="stylesheet" th:href="${assets_link}/libs/prism/themes/prism-one-light.css">
        <link rel="stylesheet" th:href="${assets_link}/libs/prism/code.css">
        <link rel="stylesheet" th:href="${assets_link}/libs/node-snackbar/snackbar.min.css">
        <link rel="stylesheet" th:href="${assets_link}/libs/aplayer/APlayer.min.css">
        <link rel="stylesheet" th:href="${assets_link}/icon/iconfont.css${theme_version}">
    </noscript>

    <!-- 滚动条样式 - 条件加载 -->
    <style th:if="${theme.config.other.scrollbarLinearGradientEnable}">
        *::-webkit-scrollbar-thumb {
            background-color: var(--heo-main);
            background-image: -webkit-linear-gradient(45deg,rgba(255,255,255,.4) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.4) 50%,rgba(255,255,255,.4) 75%,transparent 75%,transparent);
            border-radius: 2em
        }
    </style>

    <!-- 条件性资源加载 -->
    <th:block th:if="${theme.config.top.moment}">
        <link rel="preload" th:href="${assets_link + '/libs/swiper/swiper-bundle.min.css'}" as="style" onload="this.onload=null">
        <link rel="prefetch" th:href="${assets_link + '/libs/swiper/swiper-bundle.min.css'}">
    </th:block>

    <!-- 通知系统CSS - 异步加载 -->
    <link rel="preload" th:href="${assets_link + '/libs/node-snackbar/snackbar.min.css'}" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" th:href="${assets_link + '/libs/node-snackbar/snackbar.min.css'}"></noscript>

    <!-- 代码高亮CSS - 延迟加载 -->
    <link rel="preload" th:href="${assets_link + '/libs/prism/prism.min.css'}" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" th:href="${assets_link + '/libs/prism/themes/prism-one-light.css'}" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" th:href="${assets_link + '/libs/prism/code.css'}" as="style" onload="this.onload=null;this.rel='stylesheet'">

    <!-- 代码块自动识别语言 -->
    <th:block th:replace="~{modules/common/code}"/>
    <!-- 代码块 -->
    <th:block th:replace="~{macro/prism-code}"/>

    <!-- 页脚内容-样式一 -->
    <th:block th:replace="~{modules/common/footer-style-one}"/>

    <!-- 核心工具函数 - 内联 -->
    <script>
        (win => {
            win.saveToLocal = {
                set: function setWithExpiry(key, value, ttl) {
                    if (ttl === 0) return
                    const now = new Date()
                    const expiryDay = ttl * 86400000
                    const item = {
                        value: value,
                        expiry: now.getTime() + expiryDay,
                    }
                    localStorage.setItem(key, JSON.stringify(item))
                },
                get: function getWithExpiry(key) {
                    const itemStr = localStorage.getItem(key)
                    if (!itemStr) return undefined
                    const item = JSON.parse(itemStr)
                    const now = new Date()
                    if (now.getTime() > item.expiry) {
                        localStorage.removeItem(key)
                        return undefined
                    }
                    return item.value
                }
            }

            win.getScript = url => new Promise((resolve, reject) => {
                const script = document.createElement('script')
                script.src = url
                script.async = true
                script.onerror = reject
                script.onload = script.onreadystatechange = function () {
                    const loadState = this.readyState
                    if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
                    script.onload = script.onreadystatechange = null
                    resolve()
                }
                document.head.appendChild(script)
            })

            win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
                const link = document.createElement('link')
                link.rel = 'stylesheet'
                link.href = url
                if (id) link.id = id
                link.onerror = reject
                link.onload = link.onreadystatechange = function() {
                    const loadState = this.readyState
                    if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
                    link.onload = link.onreadystatechange = null
                    resolve()
                }
                document.head.appendChild(link)
            })

            win.activateDarkMode = function () {
                document.documentElement.setAttribute('data-theme', 'dark')
                document.documentElement.classList.add('color-scheme-dark')
                if (typeof heo !== 'undefined') heo.initThemeColor()
            }
            win.activateLightMode = function () {
                document.documentElement.setAttribute('data-theme', 'light')
                document.documentElement.classList.remove('color-scheme-dark')
                if (typeof heo !== 'undefined') heo.initThemeColor()
            }
            
            const t = saveToLocal.get('theme')
            const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
            const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
            const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
            const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

            if (t === undefined) {
                if (isLightMode) activateLightMode()
                else if (isDarkMode) activateDarkMode()
                else if (isNotSpecified || hasNoSupport) {
                    const now = new Date()
                    const hour = now.getHours()
                    const isNight = hour <= 6 || hour >= 18
                    isNight ? activateDarkMode() : activateLightMode()
                }
                window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
                    if (saveToLocal.get('theme') === undefined) {
                        e.matches ? activateDarkMode() : activateLightMode()
                    }
                })
            } else if (t === 'light') activateLightMode()
            else activateDarkMode()

            if("[[${theme.config.style.colorScheme}]]" === 'dark') activateDarkMode()
            if("[[${theme.config.style.colorScheme}]]" === 'light') activateLightMode()

            const asideStatus = saveToLocal.get('aside-status')
            if (asideStatus !== undefined) {
                if (asideStatus === 'hide') {
                    document.documentElement.classList.add('hide-aside')
                } else {
                    document.documentElement.classList.remove('hide-aside')
                }
            }
        })(window)
    </script>

    <!-- 动态加载条 - 延迟加载 -->
    <script th:if="${theme.config.other.loadingBoxs.loadProgressBar}">
        (function(){
            // 延迟2秒加载进度条，避免阻塞首屏
            setTimeout(function() {
                var script = document.createElement('script');
                script.src = '[[${assets_link}]]/libs/pace/pace.min.js';
                script.setAttribute('data-pace-options', '{"restartOnRequestAfter":false,"eventLag":false}');
                document.head.appendChild(script);
            }, 2000);
        })();
    </script>

    <!-- 复制功能 - 延迟加载 -->
    <script>
        // 延迟1.5秒加载剪贴板功能
        setTimeout(function() {
            var script = document.createElement('script');
            script.src = '[[${assets_link}]]/libs/clipboard/clipboard.min.js';
            script.async = true;
            document.head.appendChild(script);
        }, 1500);
    </script>

    <!-- 统计功能 - 条件延迟加载 -->
    <script th:if="${#strings.contains(theme.config.about.widget_list,'statistics-map')}">
        // 延迟2秒加载统计功能
        setTimeout(function() {
            var script = document.createElement('script');
            script.src = '[[${assets_link}]]/libs/countup/countup.js';
            script.async = true;
            document.head.appendChild(script);
        }, 2000);
    </script>

    <!-- icon图标 - 预加载 -->
    <link rel="preload" th:href="${assets_link + '/icon/iconfont.css' + theme_version}" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" th:href="${assets_link + '/icon/iconfont.css' + theme_version}"></noscript>

    <th:block th:replace="~{modules/variables/site-config}" />

    <!-- 分析脚本 - 最后加载 -->
    <script>
        // 延迟3秒加载分析脚本，确保不影响用户体验
        setTimeout(function() {
            if (typeof umami === 'undefined') {
                var script = document.createElement('script');
                script.src = 'https://cloud.umami.is/script.js';
                script.async = true;
                script.setAttribute('data-host-url', 'https://cloud.umami.is');
                script.setAttribute('data-website-id', 'your-website-id');
                document.head.appendChild(script);
            }
        }, 3000);
    </script>

</th:block>
